import {
    Button,
    ComboBox,
    SpinBox,
    CheckBox,
    VerticalBox,
    HorizontalBox,
    GroupBox,
    GridBox,
    LineEdit,
    TabWidget,
    ScrollView,
} from "std-widgets.slint";

import { Theme } from "monte_carlo_theme.slint";

import {
    SimParams,
    SimStats,
    TickerFormData,
    TickerItem,
    PortfolioStatsData,
    TickerStatsData,
} from "monte_carlo_types.slint";

import { MonteCarloGlobal } from "monte_carlo_global.slint";

import { PortfolioList } from "components/PortfolioList.slint";
import { TickerForm } from "components/TickerForm.slint";
import { PortfolioResultsPanel } from "components/PortfolioResultsPanel.slint";
import {
    PortfolioAllocationTable,
} from "components/PortfolioAllocationTable.slint";  

export component MonteCarloPage inherits Rectangle {
    min-width: 900px;
    min-height: 600px;
    background: Theme.app-background;

    // Mode selection: 0 = Single Ticker, 1 = Portfolio
    in-out property <int> current-mode: 0;
    in-out property <TickerFormData> portfolio-form <=> MonteCarloGlobal.portfolio-form;
    in-out property <[TickerItem]> portfolio-tickers <=> MonteCarloGlobal.portfolio-tickers;
    in-out property <float> portfolio-total-weight <=> MonteCarloGlobal.portfolio-total-weight;
    in-out property <string> portfolio-validation-message <=> MonteCarloGlobal.portfolio-validation-message;
    in-out property <PortfolioStatsData> portfolio-stats <=> MonteCarloGlobal.portfolio-stats;
    in-out property <[TickerStatsData]> ticker-stats-list <=> MonteCarloGlobal.ticker-stats-list;
    in-out property <int> portfolio-results-tab: 0;
    in-out property <[string]> ticker_list <=> MonteCarloGlobal.ticker-list;
    in-out property <string> selected_ticker <=> MonteCarloGlobal.selected-ticker;
    in-out property <string> date_range <=> MonteCarloGlobal.date-range;
    in-out property <string> record_count <=> MonteCarloGlobal.record-count;
    in-out property <float> initial_price <=> MonteCarloGlobal.initial-price;
    in-out property <int> horizon: 30;
    in-out property <int> num_paths: 1000;
    in-out property <float> mu <=> MonteCarloGlobal.mu;
    in-out property <float> sigma <=> MonteCarloGlobal.sigma;
    in-out property <int> seed: 12345;
    in-out property <bool> use_antithetic: true;
    in-out property <string> model_type: "GBM";
    in-out property <float> lambda: 2.0;
    in-out property <float> mu_j: -0.02;
    in-out property <float> sigma_j: 0.05;
    in-out property <float> omega: 0.00001;
    in-out property <float> alpha: 0.1;
    in-out property <float> beta: 0.85;
    in property <SimStats> stats <=> MonteCarloGlobal.stats;
    in-out property <image> price_chart <=> MonteCarloGlobal.price-chart;
    in-out property <image> hist_chart <=> MonteCarloGlobal.hist-chart;
    in-out property <string> exec_time <=> MonteCarloGlobal.exec-time;

    // Portfolio Allocation Table state
    in-out property <int> portfolio-visible-count: 2;  // Start with 2 rows


    // Top mode switch
    VerticalBox {
        vertical-stretch: 0;

        // --- Single ticker mode (refactored with scrollable full-screen sections) ---
        if root.current-mode == 0: ScrollView {
            VerticalBox {
                spacing: 0px;  // Kh√¥ng c√≥ spacing gi·ªØa c√°c section
                padding: 0px;
                Rectangle {
                    height: root.height;  // Chi·∫øm ƒë√∫ng 1 m√†n h√¨nh
                    background: Theme.panel-background;
                    VerticalBox {
                        padding: 20px;
                        spacing: 15px;
                        alignment: center;
                        
                        // Title
                        Text {
                            text: "üìä Monte Carlo Simulation - Input Parameters";
                            font-size: 20px;
                            font-weight: 700;
                            color: Theme.text-primary;
                            horizontal-alignment: center;
                        }

                        Rectangle {
                            height: 10px;
                        }
                            // S·ª≠ d·ª•ng component
                            PortfolioAllocationTable {
                            // Bind visible-count to parent property
                            visible-count <=> root.portfolio-visible-count;

                            // Handle ticker changed
                            ticker-changed(index, ticker) => {
                                debug("Asset", index, "ticker changed:", ticker);
                                // TODO: Save to backend or validate ticker
                            }

                            // Handle weight changed
                            weight-changed(index, weight) => {
                                debug("Asset", index, "weight changed:", weight);
                                // TODO: Save to backend or recalculate total
                            }

                            // Handle search ticker icon clicked
                            search-ticker(index) => {
                                debug("Search ticker for asset", index);
                                // TODO: Open search popup/dialog
                            }

                            // Handle "More" button clicked
                            add-more-rows() => {
                                // Add 2 more rows (maximum 20)
                                debug("More button clicked! Current count:", root.portfolio-visible-count);

                                if (root.portfolio-visible-count < 20) {
                                    root.portfolio-visible-count += 2;

                                    // Cap at 20
                                    if (root.portfolio-visible-count > 20) {
                                        root.portfolio-visible-count = 20;
                                    }

                                    debug("Added 2 rows. New total:", root.portfolio-visible-count);
                                } else {
                                    debug("Maximum 20 tickers reached!");
                                }
                            }
                        }

                        Rectangle {
                            height: 20px;
                        }  // Kho·∫£ng c√°ch gi·ªØa b·∫£ng v√† form

                            VerticalBox {
                            spacing: 40px;
                            alignment: start;
                            max-width: 600px;
                            padding-left: 60px;
                            padding-right: 60px;
                                
                                
                                // Model
                                HorizontalBox {
                                spacing: 25px;
                                alignment: start;
                                Text {
                                    text: "Model:";
                                    font-size: 11px;
                                    color: Theme.text-muted;
                                    vertical-alignment: center;
                                    width: 250px;
                                }

                                ComboBox {
                                    model: ["GBM", "Bootstrap", "JumpDiffusion", "GARCH"];
                                    selected => {
                                        root.model_type = self.current-value;
                                    }
                                    height: Theme.control-height;
                                    horizontal-stretch: 1;
                                    width: 300px;
                                }
                            }
                                
                                // Initial Price
                                HorizontalBox {
                                spacing: 25px;
                                alignment: start;
                                Text {
                                    text: "Initial Amount ($):";
                                    font-size: 11px;
                                    color: Theme.text-muted;
                                    vertical-alignment: center;
                                    width: 250px;
                                }

                                Rectangle {
                                    border-radius: 4px;
                                    background: #eef5ff;
                                    width: 300px;
                                    height: 30px;
                                    TextInput {
                                        text: "1000000";
                                        height: 100%;
                                        font-size: 14px;
                                        input-type: text;
                                        vertical-alignment: center;
                                        horizontal-alignment: left;
                                    }
                                }
                            }
                                
                                HorizontalBox {
                                spacing: 25px;
                                alignment: start;
                                Text {
                                    text: "Simualation Period:";
                                    font-size: 11px;
                                    color: Theme.text-muted;
                                    vertical-alignment: center;
                                    width: 250px;
                                }

                                ComboBox {
                                    model: ["5", "10", "15", "20", "25", "30", "45", "50"];
                                    // selected => {
                                    //     root.model_type = self.current-value;
                                    // }
                                    height: Theme.control-height;
                                    horizontal-stretch: 1;
                                    width: 300px;
                                }
                            }
                                
                                // Paths
                                HorizontalBox {
                                spacing: 25px;
                                alignment: start;
                                Text {
                                    text: "Number Paths:";
                                    font-size: 11px;
                                    color: Theme.text-muted;
                                    vertical-alignment: center;
                                    width: 250px;
                                }

                                SpinBox {
                                    value <=> root.num_paths;
                                    maximum: 100000;
                                    step-size: 100;
                                    height: Theme.control-height;
                                    horizontal-stretch: 1;
                                    width: 300px;
                                }
                            }
                                
                                // Seed
                                HorizontalBox {
                                spacing: 25px;
                                alignment: start;
                                Text {
                                    text: "Volatility Override:  :";
                                    font-size: 11px;
                                    color: Theme.text-muted;
                                    vertical-alignment: center;
                                    width: 250px;
                                }

                                ComboBox {
                                    model: ["Auto", "Manual"];
                                    // selected => {
                                    //     root.model_type = self.current-value;
                                    // }
                                    height: Theme.control-height;
                                    horizontal-stretch: 1;
                                    width: 300px;
                                }
                            }
                                
                                // Setup buttons
                                HorizontalBox {
                                spacing: 25px;
                                alignment: start;
                                Text {
                                    text: "Setup:";
                                    font-size: 11px;
                                    color: Theme.text-muted;
                                    vertical-alignment: center;
                                    width: 250px;
                                }

                                Button {
                                    text: "üíæ Save";
                                    height: Theme.control-height;
                                    clicked => {
                                        MonteCarloGlobal.save_setup_pressed();
                                        
                                    }
                                    width: 125px;
                                }

                                Button {
                                    text: "üìÇ Load";
                                    height: Theme.control-height;
                                    clicked => {
                                        MonteCarloGlobal.load_setup_pressed();
                                    }
                                    width: 125px;
                                }

                                Rectangle {
                                    horizontal-stretch: 1;
                                }  // Spacer
                                }
                                
                                // Antithetic Variates checkbox
                                HorizontalBox {
                                spacing: 25px;
                                alignment: start;
                                Rectangle {
                                    min-width: 120px;
                                }  // Spacer ƒë·ªÉ align v·ªõi c√°c field kh√°c
                                    
                                    CheckBox {
                                    checked <=> root.use_antithetic;
                                }

                                Text {
                                    text: "Use Antithetic Variates";
                                    color: Theme.text-primary;
                                    font-size: 12px;
                                    vertical-alignment: center;
                                }

                                Rectangle {
                                    horizontal-stretch: 1;
                                }  // Spacer
                                }

                            VerticalBox {
                                alignment: center;
                                spacing: 100px;
                                
                                Button {
                                    text: "‚ñ∂ Run Simulation";
                                    primary: true;
                                    height: 45px;
                                    width: 220px;
                                    clicked => {
                                        MonteCarloGlobal.run_simulation_pressed({
                                            initial_price: root.initial_price,
                                            horizon: root.horizon,
                                            num_paths: root.num_paths,
                                            mu: root.mu,
                                            sigma: root.sigma,
                                            seed: root.seed,
                                            use_antithetic: root.use_antithetic,
                                            dt: 1,
                                            model_type: root.model_type,
                                            lambda: root.lambda,
                                            mu_j: root.mu_j,
                                            sigma_j: root.sigma_j,
                                            omega: root.omega,
                                            alpha: root.alpha,
                                            beta: root.beta,
                                        });
                                    }
                                }
                            }
                        }

                        // Spacer ƒë·ªÉ ƒë·∫©y n·ªôi dung l√™n tr√™n
                        Rectangle {
                            vertical-stretch: 1;
                        }

                        // // Hint ƒë·ªÉ scroll xu·ªëng
                        // Text {
                        //     text: "üëá Scroll down to view results";
                        //     font-size: 12px;
                        //     color: Theme.text-muted;
                        //     horizontal-alignment: center;
                        // }
                    }
                }

                // ========================================
                // 2Ô∏è‚É£ PRICE CHART SECTION - Full Screen
                // ========================================
                Rectangle {
                    height: root.height;
                    background: Theme.chart-background;
                    VerticalBox {
                        padding: 20px;
                        spacing: 10px;

                        // Title
                        Text {
                            text: "üìà Price Paths Simulation";
                            font-size: 20px;
                            font-weight: 700;
                            color: Theme.text-primary;
                            horizontal-alignment: center;
                        }

                        // Chart container
                        Rectangle {
                            background: #1e1e1e;
                            border-radius: 8px;
                            vertical-stretch: 1;
                            Image {
                                source <=> root.price_chart;
                                image-fit: contain;
                                width: 100%;
                                height: 100%;
                            }
                        }

                        // Navigation hint
                        HorizontalBox {
                            spacing: 20px;
                            alignment: center;
                            Text {
                                text: "üëÜ Scroll up for inputs";
                                font-size: 12px;
                                color: Theme.text-muted;
                            }

                            Text {
                                text: "üëá Scroll down for histogram";
                                font-size: 12px;
                                color: Theme.text-muted;
                            }
                        }
                    }
                }

                // ========================================
                // 3Ô∏è‚É£ HISTOGRAM SECTION - Full Screen
                // ========================================
                Rectangle {
                    height: root.height;
                    background: Theme.chart-background;
                    VerticalBox {
                        padding: 20px;
                        spacing: 10px;

                        // Title
                        Text {
                            text: "üìä Final Price Distribution (Histogram)";
                            font-size: 20px;
                            font-weight: 700;
                            color: Theme.text-primary;
                            horizontal-alignment: center;
                        }

                        // Chart container
                        Rectangle {
                            background: #1e1e1e;
                            border-radius: 8px;
                            vertical-stretch: 1;
                            Image {
                                source <=> root.hist_chart;
                                image-fit: contain;
                                width: 100%;
                                height: 100%;
                            }
                        }

                        // Navigation hint
                        HorizontalBox {
                            spacing: 20px;
                            alignment: center;
                            Text {
                                text: "üëÜ Scroll up for price paths";
                                font-size: 12px;
                                color: Theme.text-muted;
                            }

                            Text {
                                text: "üëá Scroll down for statistics";
                                font-size: 12px;
                                color: Theme.text-muted;
                            }
                        }
                    }
                }

                // ========================================
                // 4Ô∏è‚É£ SUMMARY STATISTICS SECTION - Full Screen
                // ========================================
                Rectangle {
                    min-height: root.height;
                    background: Theme.panel-background;
                    ScrollView {
                        VerticalBox {
                            padding: 20px;
                            spacing: 15px;

                            // Title
                            Text {
                                text: "üìä Statistical Summary & Export";
                                font-size: 20px;
                                font-weight: 700;
                                color: Theme.text-primary;
                                horizontal-alignment: center;
                            }

                            Text {
                                text: "Statistical Summary";
                                font-weight: 600;
                                color: #f7f5f5;
                            }

                            GridBox {
                                Row {
                                    Text {
                                        text: "Mean:";
                                        color: #f7f5f5;
                                    }

                                    Text {
                                        text: stats.mean;
                                        color: #f7f5f5;
                                    }
                                }

                                Row {
                                    Text {
                                        text: "Std Dev:";
                                        color: #f7f5f5;
                                    }

                                    Text {
                                        text: stats.std_dev;
                                        color: #f7f5f5;
                                    }
                                }

                                Row {
                                    Text {
                                        text: "Median (P50):";
                                        color: #f7f5f5;
                                    }

                                    Text {
                                        text: stats.median;
                                        color: #f7f5f5;
                                    }
                                }

                                Row {
                                    Text {
                                        text: "Sharpe Ratio:";
                                        font-weight: 600;
                                        color: #f7f5f5;
                                    }

                                    Text {
                                        text: stats.sharpe-ratio;
                                        color: stats.sharpe-ratio > 1.0 ? #4caf50 : (stats.sharpe-ratio > 0.5 ? #ff9800 : #f44336);
                                        font-weight: 700;
                                        font-size: 14px;
                                    }
                                }

                                Row {
                                    Text {
                                        text: "Best Case:";
                                        font-weight: 600;
                                        color: #f7f5f5;
                                    }

                                    Text {
                                        text: stats.best-case;
                                        color: #4caf50;
                                        font-weight: 700;
                                        font-size: 14px;
                                    }
                                }

                                Row {
                                    Text {
                                        text: "Worst Case:";
                                        font-weight: 600;
                                        color: #f7f5f5;
                                    }

                                    Text {
                                        text: stats.worst-case;
                                        color: #f44336;
                                        font-weight: 700;
                                        font-size: 14px;
                                    }
                                }

                                Row {
                                    Text {
                                        text: "Max Drawdown:";
                                        font-weight: 600;
                                        color: #f7f5f5;
                                    }

                                    Text {
                                        text: (stats.max-drawdown * 100) + "%";
                                        color: #f44336;
                                        font-weight: 700;
                                        font-size: 14px;
                                    }
                                }

                                Row {
                                    Text {
                                        text: "P5:";
                                        color: #f7f5f5;
                                    }

                                    Text {
                                        text: stats.p5;
                                        color: #f7f5f5;
                                    }
                                }

                                Row {
                                    Text {
                                        text: "P25:";
                                        color: #f7f5f5;
                                    }

                                    Text {
                                        text: stats.p25;
                                        color: #f7f5f5;
                                    }
                                }

                                Row {
                                    Text {
                                        text: "P75:";
                                        color: #f7f5f5;
                                    }

                                    Text {
                                        text: stats.p75;
                                        color: #f7f5f5;
                                    }
                                }

                                Row {
                                    Text {
                                        text: "P95:";
                                        color: #f7f5f5;
                                    }

                                    Text {
                                        text: stats.p95;
                                        color: #f7f5f5;
                                    }
                                }

                                Row {
                                    Text {
                                        text: "VaR 95%:";
                                        color: #f7f5f5;
                                    }

                                    Text {
                                        text: stats.var95;
                                        color: #f7f5f5;
                                    }
                                }
                            }

                            Rectangle {
                                height: 1px;
                                background: #444;
                            }

                            Text {
                                text: "Performance";
                                font-weight: 600;
                                color: #f7f5f5;
                            }

                            Text {
                                text: "Execution time: " + root.exec_time;
                                color: #f7f5f5;
                            }

                            Rectangle {
                                height: 1px;
                                background: #444;
                            }

                            Text {
                                text: "Export Options";
                                font-weight: 600;
                                color: #f7f5f5;
                            }

                            Button {
                                text: "üíæ Save Summary (CSV)";
                                clicked => {
                                    MonteCarloGlobal.export_summary_pressed();
                                }
                            }

                            Button {
                                text: "üì∏ Save Charts (PNG)";
                                clicked => {
                                    MonteCarloGlobal.export_charts_pressed();
                                }
                            }

                            // Back to top hint
                            Rectangle {
                                height: 20px;
                            }

                            Text {
                                text: "üëÜ Scroll to top";
                                font-size: 12px;
                                color: Theme.text-muted;
                                horizontal-alignment: center;
                            }
                        }
                    }
                }
            }
        }

        // --- Portfolio mode composition: use separated components ---
        if root.current-mode == 1: VerticalBox {
            padding: 6px;
            spacing: 6px;
            TickerForm {
                available-tickers: root.ticker_list;
                form-data <=> root.portfolio-form;
                vertical-stretch: 0;
                max-height: 180px;
                ticker-selected(ticker) => {
                    MonteCarloGlobal.ticker_selected_for_portfolio(ticker);
                }
                estimate-params => {
                    MonteCarloGlobal.estimate_params_for_portfolio();
                }
                add-ticker => {
                    MonteCarloGlobal.add_ticker_to_portfolio();
                }
            }

            HorizontalBox {
                spacing: 10px;
                vertical-stretch: 1;
                PortfolioList {
                    tickers <=> root.portfolio-tickers;
                    total-weight <=> root.portfolio-total-weight;
                    validation-message <=> root.portfolio-validation-message;
                    horizontal-stretch: 2;
                    vertical-stretch: 1;
                    update-ticker-field(index, field, value) => {
                        MonteCarloGlobal.update_ticker_field(index, field, value);
                    }
                    update-ticker-weight(index, weight) => {
                        MonteCarloGlobal.update_ticker_weight(index, weight);
                    }
                    remove-ticker(index) => {
                        MonteCarloGlobal.remove_ticker_from_portfolio(index);
                    }
                    auto-balance => {
                        MonteCarloGlobal.auto_balance_portfolio();
                    }
                    run-simulation => {
                        MonteCarloGlobal.run_portfolio_simulation();
                    }
                }

                VerticalBox {
                    horizontal-stretch: 1;
                    vertical-stretch: 1;
                    if root.portfolio-stats.paths > 0: GroupBox {
                        vertical-stretch: 1;
                        PortfolioResultsPanel {
                            portfolio-stats: root.portfolio-stats;
                            ticker-stats: root.ticker-stats-list;
                            current-tab <=> root.portfolio-results-tab;
                            vertical-stretch: 1;
                            horizontal-stretch: 1;
                        }
                    }
                    if root.portfolio-stats.paths == 0: GroupBox {
                        vertical-stretch: 1;
                        VerticalBox {
                            alignment: center;
                            padding: 40px;
                            Text {
                                text: "üìä Portfolio Simulation Results";
                                font-size: 18px;
                                font-weight: 700;
                                color: #2196f3;
                                horizontal-alignment: center;
                            }

                            Text {
                                text: "Build your portfolio and run simulation to see results here.";
                                font-size: 14px;
                                color: #a0a0a0;
                                horizontal-alignment: center;
                                wrap: word-wrap;
                            }
                        }
                    }
                }
            }
        }
    }
}
