import {
    Button, ComboBox, SpinBox, CheckBox,
    VerticalBox, HorizontalBox, GroupBox,
    GridBox, LineEdit, TabWidget, ScrollView
} from "std-widgets.slint";

import { Theme } from "monte_carlo_theme.slint";

import {
    SimParams, SimStats, TickerFormData, TickerItem,
    PortfolioStatsData, TickerStatsData
} from "monte_carlo_types.slint";

import { MonteCarloGlobal } from "monte_carlo_global.slint";

import { PortfolioList } from "components/PortfolioList.slint";
import { TickerForm } from "components/TickerForm.slint";
import { PortfolioResultsPanel } from "components/PortfolioResultsPanel.slint";

export component MonteCarloPage inherits Rectangle {
    min-width: 900px;
    min-height: 600px;
    background: Theme.app-background;

    // Mode selection: 0 = Single Ticker, 1 = Portfolio
    in-out property <int> current-mode: 0;

    in-out property <TickerFormData> portfolio-form <=> MonteCarloGlobal.portfolio-form;
    in-out property <[TickerItem]> portfolio-tickers <=> MonteCarloGlobal.portfolio-tickers;
    in-out property <float> portfolio-total-weight <=> MonteCarloGlobal.portfolio-total-weight;
    in-out property <string> portfolio-validation-message <=> MonteCarloGlobal.portfolio-validation-message;
    in-out property <PortfolioStatsData> portfolio-stats <=> MonteCarloGlobal.portfolio-stats;
    in-out property <[TickerStatsData]> ticker-stats-list <=> MonteCarloGlobal.ticker-stats-list;
    in-out property <int> portfolio-results-tab: 0;

    in-out property <[string]> ticker_list <=> MonteCarloGlobal.ticker-list;
    in-out property <string> selected_ticker <=> MonteCarloGlobal.selected-ticker;
    in-out property <string> date_range <=> MonteCarloGlobal.date-range;
    in-out property <string> record_count <=> MonteCarloGlobal.record-count;
    in-out property <float> initial_price <=> MonteCarloGlobal.initial-price;
    in-out property <int> horizon: 30;
    in-out property <int> num_paths: 1000;
    in-out property <float> mu <=> MonteCarloGlobal.mu;
    in-out property <float> sigma <=> MonteCarloGlobal.sigma;
    in-out property <int> seed: 12345;
    in-out property <bool> use_antithetic: true;
    in-out property <string> model_type: "GBM";

    in-out property <float> lambda: 2.0;
    in-out property <float> mu_j: -0.02;
    in-out property <float> sigma_j: 0.05;
    in-out property <float> omega: 0.00001;
    in-out property <float> alpha: 0.1;
    in-out property <float> beta: 0.85;

    in property <SimStats> stats <=> MonteCarloGlobal.stats;
    in-out property <image> price_chart <=> MonteCarloGlobal.price-chart;
    in-out property <image> hist_chart <=> MonteCarloGlobal.hist-chart;
    in-out property <string> exec_time <=> MonteCarloGlobal.exec-time;

    // // Forward callbacks to global
    // load_csv_pressed => { MonteCarloGlobal.load-csv-pressed(); }
    // select_ticker_changed => { MonteCarloGlobal.select-ticker-changed(root.selected_ticker); }
    // estimate_params_pressed => { MonteCarloGlobal.estimate-params-pressed(); }
    // run_simulation_pressed => { MonteCarloGlobal.run-simulation-pressed(root.run_simulation_pressed); }
    // export_summary_pressed => { MonteCarloGlobal.export-summary-pressed(); }
    // export_charts_pressed => { MonteCarloGlobal.export-charts-pressed(); }
    // save_setup_pressed => { MonteCarloGlobal.save-setup-pressed(); }
    // load_setup_pressed => { MonteCarloGlobal.load-setup-pressed(); }
    
    // // Portfolio callbacks forward to global
    // ticker_selected_for_portfolio => { MonteCarloGlobal.ticker-selected-for-portfolio(root.ticker_selected_for_portfolio); }
    // estimate_params_for_portfolio => { MonteCarloGlobal.estimate-params-for-portfolio(); }
    // add_ticker_to_portfolio => { MonteCarloGlobal.add-ticker-to-portfolio(); }
    // update_ticker_field => { MonteCarloGlobal.update-ticker-field(root.update_ticker_field); }
    // update_ticker_weight => { MonteCarloGlobal.update-ticker-weight(root.update_ticker_weight); }
    // remove_ticker_from_portfolio => { MonteCarloGlobal.remove-ticker-from-portfolio(root.remove_ticker_from_portfolio); }
    // auto_balance_portfolio => { MonteCarloGlobal.auto-balance-portfolio(); }
    // run_portfolio_simulation => { MonteCarloGlobal.run-portfolio-simulation(); }

    // Top mode switch
    VerticalBox {
        vertical-stretch: 0;
        HorizontalBox {
            padding: 8px;
            spacing: 8px;
            alignment: center;
            vertical-stretch: 0;
            Button {
                text: "üìä Single Ticker";
                primary: root.current-mode == 0;
                clicked => { root.current-mode = 0; }
                min-width: 160px;
                height: Theme.control-height;
            }
            Button {
                text: "üìÅ Portfolio";
                primary: root.current-mode == 1;
                clicked => { root.current-mode = 1; }
                min-width: 160px;
                height: Theme.control-height;
            }
        }

        // --- Single ticker mode (copied, layout only) ---
        if root.current-mode == 0: VerticalBox {
            padding: 6px;
            spacing: 6px;

            Rectangle {
                background: Theme.panel-background;
                border-radius: Theme.control-radius;
                VerticalBox {
                    spacing: 2px;
                    padding: 2px;
                    VerticalBox {
                        spacing: 2px;
                        padding: 2px;

                        HorizontalBox {
                            spacing: 4px;
                           
                            alignment: center;

                            // Data input (load CSV + ticker)
                            VerticalBox {
                                spacing: 1px;
                                min-height: 50px;
                                Text { text: "Ticker:"; font-size: 11px; color: Theme.text-muted; }
                                HorizontalBox {
                                    spacing: 2px;
                                    Button {
                                        text: "üìÇ Load CSV";
                                        max-width: 90px;
                                        height: Theme.control-height;
                                        clicked => { MonteCarloGlobal.load-csv-pressed(); }
                                    }
                                    ComboBox {
                                        model: root.ticker_list;
                                        selected(current-value) => {
                                            root.selected_ticker = current-value;
                                            MonteCarloGlobal.select-ticker-changed(current-value);
                                        }
                                        min-width: 140px;
                                        height: Theme.control-height;
                                    }
                                }
                            }

                            // Model selection
                            VerticalBox {
                                spacing: 1px;
                                min-height: 50px;
                                Text { text: "Model:"; font-size: 11px; color: Theme.text-muted; }
                                ComboBox {
                                    model: ["GBM", "Bootstrap", "JumpDiffusion", "GARCH"];
                                    selected => { root.model_type = self.current-value; }
                                    min-width: 140px;
                                    height: Theme.control-height;
                                }
                            }

                            // Initial price
                            VerticalBox {
                                spacing: 1px;
                                min-height: 50px;
                                Text { text: "Price ($):"; font-size: 11px; color: Theme.text-muted; }
                                LineEdit {
                                    text: root.initial_price;
                                    edited(text) => { root.initial_price = text.to-float(); }
                                    placeholder-text: "150.00";
                                    min-width: 90px;
                                    height: Theme.control-height;
                                }
                            }

                            // Horizon
                            VerticalBox {
                                spacing: 1px;
                                min-height: 50px;
                                Text { text: "Horizon (days):"; font-size: 11px; color: Theme.text-muted; }
                                SpinBox {
                                    value <=> root.horizon;
                                    min-width: 90px;
                                    height: Theme.control-height;
                                }
                            }

                            // Num paths
                            VerticalBox {
                                spacing: 1px;
                                min-height: 50px;
                                Text { text: "Paths:"; font-size: 11px; color: Theme.text-muted; }
                                SpinBox {
                                    value <=> root.num_paths;
                                    maximum: 100000;
                                    step-size: 100;
                                    min-width: 90px;
                                    height: Theme.control-height;
                                }
                            }

                            // Seed
                            VerticalBox {
                                spacing: 1px;
                                min-height: 50px;
                                Text { text: "Seed:"; font-size: 11px; color: Theme.text-muted; }
                                SpinBox {
                                    value <=> root.seed;
                                    maximum: 100000;
                                    min-width: 90px;
                                    height: Theme.control-height;
                                }
                            }

                            // Save / load setup
                            VerticalBox {
                                spacing: 1px;
                                min-height: 50px;
                                HorizontalBox {
                                    spacing: 3px;
                                    Button {
                                        text: "üíæ";
                                        max-width: 40px;
                                        height: Theme.control-height;
                                        clicked => { MonteCarloGlobal.save_setup_pressed(); }
                                    }
                                    Button {
                                        text: "üìÇ";
                                        max-width: 40px;
                                        height: Theme.control-height;
                                        clicked => { MonteCarloGlobal.load_setup_pressed(); }
                                    }
                                }
                            }

                            // Antithetic checkbox
                            VerticalBox {
                                spacing: 1px;
                                min-height: 50px;
                                HorizontalBox {
                                    spacing: 5px;
                                    alignment: start;
                                    CheckBox { checked <=> root.use_antithetic; }
                                    Text {
                                        text: "Use Antithetic Variates";
                                        color: Theme.text-primary;
                                        font-size: 11px;
                                        vertical-alignment: center;
                                    }
                                }
                            }

                            // Run button
                            VerticalBox {
                                spacing: 1px;
                                min-height: 50px;
                                Button {
                                    text: "‚ñ∂ Run Simulation";
                                    primary: true;
                                    height: Theme.control-height;
                                    clicked => {
                                       MonteCarloGlobal.run_simulation_pressed({
                                            initial_price: root.initial_price,
                                            horizon: root.horizon,
                                            num_paths: root.num_paths,
                                            mu: root.mu,
                                            sigma: root.sigma,
                                            seed: root.seed,
                                            use_antithetic: root.use_antithetic,
                                            dt: 1,
                                            model_type: root.model_type,
                                            lambda: root.lambda,
                                            mu_j: root.mu_j,
                                            sigma_j: root.sigma_j,
                                            omega: root.omega,
                                            alpha: root.alpha,
                                            beta: root.beta,
                                        });
                                    }
                                }
                            }
                        }

                    }
                }
            }

            // Charts + summary (co gi√£n theo chi·ªÅu cao c·ª≠a s·ªï)
            HorizontalBox {
                spacing: 10px;
                vertical-stretch: 1;

                GroupBox {
                    horizontal-stretch: 3;
                    vertical-stretch: 1;
                    Rectangle {
                        background: Theme.chart-background;
                        border-radius: 8px;
                        TabWidget {
                            vertical-stretch: 1;
                            Tab {
                                title: "Price Paths";
                                VerticalBox {
                                    spacing: 10px;
                                    padding: 5px;
                                    Image {
                                        source <=> root.price_chart;
                                        image-fit: fill;
                                        vertical-stretch: 1;
                                    }
                                }
                            }
                            Tab {
                                title: "Histogram";
                                VerticalBox {
                                    spacing: 10px;
                                    padding: 5px;
                                    Image {
                                        source <=> root.hist_chart;
                                        image-fit: fill;
                                        vertical-stretch: 1;
                                    }
                                }
                            }
                        }
                    }
                }

                // Right summary panel (copied)
                GroupBox {
                    horizontal-stretch: 1;
                    vertical-stretch: 1;
                    ScrollView {
                        VerticalBox {
                            spacing: 10px;
                            padding: 10px;
                            Text { text: "Statistical Summary"; font-weight: 600; color: #f7f5f5; }
                            GridBox {
                                Row { Text { text: "Mean:"; color: #f7f5f5; }
                                      Text { text: stats.mean; color: #f7f5f5; } }
                                Row { Text { text: "Std Dev:"; color: #f7f5f5; }
                                      Text { text: stats.std_dev; color: #f7f5f5; } }
                                Row { Text { text: "Median (P50):"; color: #f7f5f5; }
                                      Text { text: stats.median; color: #f7f5f5; } }
                                Row { 
                                    Text { text: "Sharpe Ratio:"; font-weight: 600; color: #f7f5f5; }
                                    Text { 
                                        text: stats.sharpe-ratio; 
                                        color: stats.sharpe-ratio > 1.0 ? #4caf50 : (stats.sharpe-ratio > 0.5 ? #ff9800 : #f44336);
                                        font-weight: 700;
                                        font-size: 14px;
                                    }
                                }
                                Row { 
                                    Text { text: "Best Case:"; font-weight: 600; color: #f7f5f5; }
                                    Text { 
                                        text: stats.best-case; 
                                        color: #4caf50;
                                        font-weight: 700;
                                        font-size: 14px;
                                    }
                                }
                                Row { 
                                    Text { text: "Worst Case:"; font-weight: 600; color: #f7f5f5; }
                                    Text { 
                                        text: stats.worst-case; 
                                        color: #f44336;
                                        font-weight: 700;
                                        font-size: 14px;
                                    }
                                }
                                Row { 
                                    Text { text: "Max Drawdown:"; font-weight: 600; color: #f7f5f5; }
                                    Text { 
                                        text: (stats.max-drawdown * 100) + "%"; 
                                        color: #f44336;
                                        font-weight: 700;
                                        font-size: 14px;
                                    }
                                }
                                Row { Text { text: "P5:"; color: #f7f5f5; }
                                      Text { text: stats.p5; color: #f7f5f5; } }
                                Row { Text { text: "P25:"; color: #f7f5f5; }
                                      Text { text: stats.p25; color: #f7f5f5; } }
                                Row { Text { text: "P75:"; color: #f7f5f5; }
                                      Text { text: stats.p75; color: #f7f5f5; } }
                                Row { Text { text: "P95:"; color: #f7f5f5; }
                                      Text { text: stats.p95; color: #f7f5f5; } }
                                Row { Text { text: "VaR 95%:"; color: #f7f5f5; }
                                      Text { text: stats.var95; color: #f7f5f5; } }
                            }
                            Rectangle { height: 1px; background: #444; }
                            Text { text: "Performance"; font-weight: 600; color: #f7f5f5; }
                            Text { text: "Execution time: " + root.exec_time; color: #f7f5f5; }
                            Rectangle { height: 1px; background: #444; }
                            Text { text: "Export Options"; font-weight: 600; color: #f7f5f5; }
                            Button {
                                text: "üíæ Save Summary (CSV)";
                                clicked => { MonteCarloGlobal.export_summary_pressed(); }
                            }
                            Button {
                                text: "üì∏ Save Charts (PNG)";
                                clicked => { MonteCarloGlobal.export_charts_pressed(); }
                            }
                        }
                    }
                }
            }
        }

        // --- Portfolio mode composition: use separated components ---
        if root.current-mode == 1: VerticalBox {
            padding: 6px;
            spacing: 6px;

            TickerForm {
                available-tickers: root.ticker_list;
                form-data <=> root.portfolio-form;
                vertical-stretch: 0;
                max-height: 180px;
                ticker-selected(ticker) => { MonteCarloGlobal.ticker_selected_for_portfolio(ticker); }
                estimate-params => { MonteCarloGlobal.estimate_params_for_portfolio(); }
                add-ticker => { MonteCarloGlobal.add_ticker_to_portfolio(); }
            }

            HorizontalBox {
                spacing: 10px;
                vertical-stretch: 1;

                PortfolioList {
                    tickers <=> root.portfolio-tickers;
                    total-weight <=> root.portfolio-total-weight;
                    validation-message <=> root.portfolio-validation-message;
                    horizontal-stretch: 2;
                    vertical-stretch: 1;
                    update-ticker-field(index, field, value) => {
                        MonteCarloGlobal.update_ticker_field(index, field, value);
                    }
                    update-ticker-weight(index, weight) => {
                        MonteCarloGlobal.update_ticker_weight(index, weight);
                    }
                    remove-ticker(index) => { MonteCarloGlobal.remove_ticker_from_portfolio(index); }
                    auto-balance => { MonteCarloGlobal.auto_balance_portfolio(); }
                    run-simulation => { MonteCarloGlobal.run_portfolio_simulation(); }
                }

                VerticalBox {
                    horizontal-stretch: 1;
                    vertical-stretch: 1;

                    if root.portfolio-stats.paths > 0: GroupBox {
                        vertical-stretch: 1;
                        PortfolioResultsPanel {
                            portfolio-stats: root.portfolio-stats;
                            ticker-stats: root.ticker-stats-list;
                            current-tab <=> root.portfolio-results-tab;
                            vertical-stretch: 1;
                            horizontal-stretch: 1;
                        }
                    }

                    if root.portfolio-stats.paths == 0: GroupBox {
                        vertical-stretch: 1;
                        VerticalBox {
                            alignment: center;
                            padding: 40px;
                            Text {
                                text: "üìä Portfolio Simulation Results";
                                font-size: 18px;
                                font-weight: 700;
                                color: #2196f3;
                                horizontal-alignment: center;
                            }
                            Text {
                                text: "Build your portfolio and run simulation to see results here.";
                                font-size: 14px;
                                color: #a0a0a0;
                                horizontal-alignment: center;
                                wrap: word-wrap;
                            }
                        }
                    }
                }
            }
        }
    }

}


